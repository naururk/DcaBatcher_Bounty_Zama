<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <!-- Needed for Zama Relayer SDK (WASM / SharedArrayBuffer) -->
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin" />
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Private DCA Bot — Zama FHEVM</title>
    <style>
      :root{
        --bg:#f6f7fb;
        --card:#ffffff;
        --stroke:#e6e9f2;
        --ink:#0b1324;
        --muted:#77809a;
        --accent:#ffd028;
        --accent-ink:#1f1600;
        --brand:#111;
        --ring:rgba(17,17,17,.08);
        --shadow:0 10px 22px rgba(20,25,45,.06), 0 2px 8px rgba(20,25,45,.04);
      }
      *{box-sizing:border-box}
      body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}

      /* Navbar */
      .nav{position:sticky;top:0;z-index:20;background:var(--accent);box-shadow:0 2px 0 rgba(0,0,0,.05)}
      .nav .bar{max-width:1180px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:14px 18px}
      .brand{display:flex;align-items:center;gap:10px;color:#111;font-weight:800}
      .pill{background:rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.08);padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700}

      /* Layout */
      .wrap{max-width:1180px;margin:22px auto;padding:0 18px}
      .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
      @media (max-width:980px){ .grid{grid-template-columns:1fr} }

      /* Cards */
      .card{background:var(--card);border:1px solid var(--stroke);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
      .card h3{margin:0 0 12px;font-size:16px}
      .sub{margin:0 0 8px;font-size:13px;color:var(--muted)}
      .section{display:grid;grid-template-columns:1fr 1fr;gap:12px}
      .section-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
      .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

      /* Inputs */
      label{display:flex;align-items:center;gap:6px;margin:0 0 6px;color:var(--muted);font-size:12px}
      input{
        width:100%;padding:11px 12px;border:1px solid var(--stroke);border-radius:12px;background:#fff;color:var(--ink);
        outline:none;box-shadow:0 0 0 0 var(--ring);transition:box-shadow .15s,border-color .15s;
      }
      input:focus{border-color:#cfd5e6;box-shadow:0 0 0 4px var(--ring)}
      input[disabled]{background:#f4f6fb;color:#97a0b5}

      /* Buttons */
      .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
      .btn{
        padding:11px 14px;border:0;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:0 2px 0 rgba(0,0,0,.06);
        background:var(--accent);color:var(--accent-ink);
      }
      .btn:disabled{opacity:.55;cursor:not-allowed}
      .btn-outline{background:#fff;border:1px solid var(--stroke);color:var(--ink);box-shadow:none}
      .btn-grey{background:#eef1f7;color:#0b1324;font-weight:700}
      .btn-ghost{background:transparent;border:1px solid var(--stroke);color:var(--ink)}

      /* Top right controls */
      .right{display:flex;align-items:center;gap:10px}
      .badge{background:#fff;border:1px solid rgba(0,0,0,.08);padding:8px 12px;border-radius:999px;font-weight:700}
      .connect{padding:10px 14px;border-radius:12px;background:#111;color:#fff;font-weight:800;border:0;cursor:pointer}

      /* Stepper (small pills under navbar) */
      .stepper{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 18px}
      .step{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;border:1px solid var(--stroke);background:#fff;box-shadow:var(--shadow)}
      .step-num{width:22px;height:22px;border-radius:50%;display:grid;place-items:center;background:#111;color:#fff;font-weight:800;font-size:12px}

      /* Hints (tooltips) */
      .hint{position:relative;display:inline-grid;place-items:center;width:18px;height:18px;border-radius:50%;
            border:1px solid var(--stroke);color:#52607d;font-size:11px;cursor:help;background:#fff}
      .hint[data-tip]:hover:after{
        content:attr(data-tip);position:absolute;left:50%;transform:translateX(-50%);
        bottom:125%;min-width:220px;max-width:320px;background:#0b1324;color:#fff;padding:10px 12px;border-radius:10px;
        font-size:12px;line-height:1.35;box-shadow:0 10px 22px rgba(11,19,36,.3)
      }

      /* Log */
      #log{
        margin:0;background:#0d1220;color:#c6d6ff;border-radius:14px;padding:12px;height:420px;overflow:auto;
        font-family:"Fira Code",ui-monospace,monospace;font-size:12px
      }
      #status{margin-top:8px;color:#52607d}
      .tip{font-size:12px;color:#6b7591;margin-top:6px}
    </style>
  </head>
  <body>
    <!-- NAVBAR -->
    <div class="nav">
      <div class="bar">
        <div class="brand">
          <div style="width:12px;height:12px;background:#111;border-radius:3px"></div>
          <span>Private DeFi Portfolio</span>
          <span class="pill">ZAMA FHEVM</span>
        </div>
        <div class="right">
          <span class="badge">Network: Sepolia</span>
          <!-- ВАЖНО: id должен быть именно btnConnect (его ждёт app.js) -->
          <button id="btnConnect" class="connect">Connect</button>
        </div>
      </div>
    </div>

    <div class="wrap">
      <!-- STEPPER -->
      <div class="stepper">
        <div class="step"><span class="step-num">1</span>Connect</div>
        <div class="step"><span class="step-num">2</span>Fund</div>
        <div class="step"><span class="step-num">3</span>Plan</div>
        <div class="step"><span class="step-num">4</span>Batch</div>
        <div class="step"><span class="step-num">5</span>Finalize</div>
      </div>

      <div class="grid">
        <!-- LEFT COLUMN -->
        <div class="col">
          <!-- CONNECT -->
          <div class="card">
            <h3>Connection</h3>
            <p class="sub">Fill the contract and service endpoints. Click <b>Connect</b> in the top bar to start.</p>
            <div class="section">
              <div>
                <label>Contract <span class="hint" data-tip="DcaBatcher contract address on Sepolia">i</span></label>
                <input id="ctr" placeholder="0x...DcaBatcher" />
              </div>
              <div>
                <label>USDC <span class="hint" data-tip="Test USDC token address (6 decimals) on Sepolia">i</span></label>
                <input id="usdc" placeholder="0x...USDC (6d)" />
              </div>
            </div>
            <div class="section" style="margin-top:8px">
              <div>
                <label>Relayer URL <span class="hint" data-tip="Zama Relayer endpoint used for encryption/decryption requests">i</span></label>
                <input id="relayer" value="https://relayer.testnet.zama.cloud" />
              </div>
              <div>
                <label>Gateway URL <span class="hint" data-tip="Sepolia FHEVM gateway">i</span></label>
                <input id="gateway" value="https://gateway.sepolia.zama.ai/" />
              </div>
            </div>
            <div class="section" style="margin-top:8px">
              <div>
                <label>KMS <span class="hint" data-tip="Zama KMS contract used by relayer infra">i</span></label>
                <input id="kms" value="0x1364cBBf2cDF5032C47d8226a6f6FBD2AFCDacAC" />
              </div>
              <div>
                <label>Your address</label>
                <input id="me" disabled />
              </div>
            </div>
            <div id="status">Waiting…</div>
          </div>

          <!-- FUND -->
          <div class="card">
            <h3>Deposit</h3>
            <p class="sub">Uses the value from “Total budget (USDC, 6 decimals)” below. 1 USDC = 1,000,000.</p>
            <div class="actions">
              <button id="btnApprove" class="btn" disabled title="Approve contract to spend your USDC">Approve USDC</button>
              <button id="btnDeposit" class="btn" disabled title="Deposit USDC into contract (uses Total budget below)">Deposit USDC</button>
              <button class="btn-ghost" disabled title="Allowance & balance will be printed into the Debug Log">Check status</button>
            </div>
          </div>

          <!-- PLAN -->
          <div class="card">
            <h3>Plan (Submit DCA intent)</h3>
            <div class="section-3">
              <div>
                <label>Amount per tick (USDC, 6 decimals) <span class="hint" data-tip="USDC base units per tick. Example: 1000000 = 1 USDC">i</span></label>
                <input id="amt" type="number" value="1000000" placeholder="1000000 = 1 USDC" />
              </div>
              <div>
                <label>Total budget (USDC, 6 decimals) <span class="hint" data-tip="Max spend across swaps; also used by the Deposit button">i</span></label>
                <input id="bud" type="number" value="5000000" placeholder="5000000 = 5 USDC" />
              </div>
              <div>
                <label>Interval (sec) <span class="hint" data-tip="Pause between ticks for each participant">i</span></label>
                <input id="intv" type="number" value="60" />
              </div>
            </div>
            <div class="row" style="margin-top:8px">
              <div>
                <label>Start time (unix) <span class="hint" data-tip="First eligible timestamp for your next tick">i</span></label>
                <input id="start" type="number" />
              </div>
              <div>
                <label>Participants (comma-separated) <span class="hint" data-tip="Addresses included when you trigger a batch. Each must create their intent.">i</span></label>
                <input id="parts" placeholder="0xabc...,0xdef..." />
              </div>
            </div>
            <div class="actions">
              <button id="btnSubmit" class="btn" disabled title="Encrypts via Relayer and stores plan on-chain">Create Plan</button>
            </div>
            <div class="tip">All USDC values are base units (6 decimals).</div>
          </div>

          <!-- BATCH -->
          <div class="card">
            <h3>Batch</h3>
            <div class="row">
              <div>
                <label>Batch ID <span class="hint" data-tip="Numeric id of the batch to inspect / finalize">i</span></label>
                <input id="batchId" type="number" min="1" />
              </div>
              <div>
                <label>Total handle (encrypted) <span class="hint" data-tip="Encrypted sum of contributions in the batch">i</span></label>
                <input id="totalHandle" disabled />
              </div>
            </div>
            <div class="actions">
              <button id="btnTrigger" class="btn" disabled title="Collect due intents from “Participants” and form a batch">Trigger Batch</button>
              <button id="btnGetBatch" class="btn-outline" disabled title="Read batch info (users, encrypted total, flags)">Get Batch Info</button>
              <button id="btnPublicDecrypt" class="btn-outline" disabled title="Publicly decrypt only the aggregate total via Relayer">Public Decrypt Total</button>
            </div>
          </div>

          <!-- FINALIZE -->
          <div class="card">
            <h3>Finalize (owner)</h3>
            <p class="sub">Uses the last publicly-decrypted total (USDC base units) and calls <code>finalizeBatchWithTotal</code>.</p>
            <div class="actions">
              <button id="btnFinalize" class="btn" disabled title="Owner-only. Uses last decrypted total or decrypts again if needed">Finalize Batch</button>
            </div>
          </div>

          <!-- PRIVATE BALANCE -->
          <div class="card">
            <h3>My Private Balance</h3>
            <div class="row">
              <div>
                <label>Encrypted handle <span class="hint" data-tip="Your encrypted ETH balance in the contract">i</span></label>
                <input id="myHandle" disabled />
              </div>
              <div>
                <label>Decrypted (wei) <span class="hint" data-tip="Only you can decrypt via Relayer (EIP-712 signature)">i</span></label>
                <input id="myPlain" disabled />
              </div>
            </div>
            <div class="actions">
              <button id="btnGetBal" class="btn-outline" disabled title="Fetch my encrypted balance handle from the contract">Get My Balance</button>
              <button id="btnUserDecrypt" class="btn-outline" disabled title="User-level decrypt via Relayer">User Decrypt</button>
            </div>
          </div>
        </div>

        <!-- RIGHT COLUMN: DEBUG -->
        <div class="col">
          <div class="card">
            <h3>Debug Log</h3>
            <pre id="log"></pre>
          </div>
        </div>
      </div>
    </div>

    <!-- App logic (unchanged) -->
    <script type="module" src="./js/app.js"></script>
  </body>
</html>

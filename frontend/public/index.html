<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <!-- FHEVM / Relayer SDK needs COOP/COEP -->
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin" />
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Private DCA Bot — ZAMA FHEVM</title>
    <style>
      :root{
        --bg:#f6f7fb; --panel:#ffffff; --muted:#6b7280; --text:#0f172a;
        --primary:#ffd400; --primary-ink:#1f2937; --stroke:#e5e7eb;
        --accent:#0ea5e9; --ok:#16a34a; --bad:#ef4444; --chip:#111827;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}

      /* top bar */
      .topbar{position:sticky;top:0;z-index:20;background:var(--primary);color:var(--primary-ink);border-bottom:1px solid rgba(0,0,0,.06)}
      .topbar .inner{max-width:1200px;margin:0 auto;padding:14px 20px;display:flex;align-items:center;gap:14px}
      .brand{display:flex;align-items:center;gap:10px;font-weight:800}
      .brand .dot{width:10px;height:10px;border-radius:3px;background:#111}
      .spacer{flex:1}
      .pill{background:#fff;border:1px solid var(--stroke);padding:8px 10px;border-radius:999px;font-weight:600}
      .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:800}
      .btn:disabled{opacity:.6;cursor:not-allowed}
      .btn.dark{background:#111827;color:#fff}
      .btn.primary{background:#111827;color:#fff}
      .btn.light{background:#fff;border:1px solid var(--stroke);color:#111827}

      /* layout */
      .wrap{max-width:1200px;margin:20px auto;padding:0 20px;display:grid;gap:18px}
      .grid{display:grid;grid-template-columns:1fr;gap:18px}
      @media (min-width:1024px){ .grid{grid-template-columns:1.2fr .8fr} }
      .card{background:var(--panel);border:1px solid var(--stroke);border-radius:16px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.03)}
      h1{margin:0 0 8px;font-size:26px}
      h3{margin:0 0 12px;font-size:16px;display:flex;align-items:center;gap:8px}
      .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
      .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
      label{display:flex;align-items:center;gap:8px;margin:0 0 6px;color:var(--muted);font-size:12px}
      input,select{width:100%;padding:11px 12px;border:1px solid var(--stroke);border-radius:10px;background:#fff;color:var(--text)}
      input[disabled]{background:#f3f4f6;color:#9ca3af}
      .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
      #status{margin-top:10px;color:var(--muted)}
      .chip{display:inline-flex;align-items:center;gap:6px;background:#f3f4f6;border:1px solid var(--stroke);color:#111827;padding:6px 10px;border-radius:999px;font-weight:600}
      .chip.ok{background:#eaffef;border-color:#b7f3c7;color:#065f46}
      .chip.bad{background:#ffecec;border-color:#f7c2c2;color:#7f1d1d}
      #log{margin:0;background:#0b1220;color:#e2e8f0;border-radius:12px;padding:12px;max-height:260px;overflow:auto;
           font-family:"Fira Code",ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;white-space:pre-wrap}
      /* tooltips */
      .tip{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;background:#111827;color:#fff;
           font-size:10px;font-weight:800;cursor:help;position:relative}
      .tip::after{content:attr(data-tip);position:absolute;left:50%;top:calc(100% + 8px);transform:translateX(-50%);
        background:#111827;color:#fff;padding:8px 10px;border-radius:8px;font-size:12px;line-height:1.3;white-space:pre-wrap;
        min-width:220px;max-width:360px;opacity:0;pointer-events:none;transition:.15s;box-shadow:0 8px 20px rgba(0,0,0,.15)}
      .tip:hover::after{opacity:1}
      .sep{height:1px;background:var(--stroke);margin:12px 0}
      .section-title{display:flex;align-items:center;gap:10px;margin:2px 0 0}
      .section-title small{color:var(--muted)}
    </style>
  </head>
  <body>
    <!-- top bar -->
    <header class="topbar">
      <div class="inner">
        <div class="brand">
          <span class="dot"></span>
          Private DCA Bot
          <span class="pill">ZAMA FHEVM</span>
        </div>
        <div class="spacer"></div>
        <span class="pill">Network: Sepolia</span>
        <button id="btnConnect" class="btn dark">Connect</button>
      </div>
    </header>

    <main class="wrap">
      <div class="section-title">
        <h1>Portfolio Overview</h1>
        <small>Encrypted DCA · public total decryption</small>
      </div>

      <div class="grid">
        <!-- Connection -->
        <section class="card">
          <h3>Connection</h3>

          <div class="row">
            <div>
              <label>Contract
                <span class="tip" data-tip="Your DcaBatcher address on Sepolia. Transactions are sent here.">i</span>
              </label>
              <input id="ctr" placeholder="0x...DcaBatcher" />
            </div>
            <div>
              <label>USDC
                <span class="tip" data-tip="ERC-20 USDC (6 decimals). Used for approve and deposit.">i</span>
              </label>
              <input id="usdc" placeholder="0x...USDC (6 decimals)" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Relayer URL
                <span class="tip" data-tip="Zama Relayer endpoint used for encryption/public decryption.">i</span>
              </label>
              <input id="relayer" value="https://relayer.testnet.zama.cloud" />
            </div>
            <div>
              <label>Gateway URL
                <span class="tip" data-tip="SDK service endpoint used by the Relayer.">i</span>
              </label>
              <input id="gateway" value="https://gateway.sepolia.zama.ai/" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>KMS
                <span class="tip" data-tip="FHEVM KMS contract address (Sepolia). Required by SDK.">i</span>
              </label>
              <input id="kms" value="0x1364cBBf2cDF5032C47d8226a6f6FBD2AFCDacAC" />
            </div>
            <div>
              <label>Your Address
                <span class="tip" data-tip="Your EOA from MetaMask. Used for signatures and encryption.">i</span>
              </label>
              <input id="me" disabled />
            </div>
          </div>

          <div class="actions">
            <button id="btnApprove" class="btn light" disabled>
              Approve USDC <span class="tip" data-tip="ERC-20 approve so the contract can pull your USDC.">i</span>
            </button>
            <button id="btnDeposit" class="btn primary" disabled>
              Deposit USDC <span class="tip" data-tip="Send USDC to the contract (amount is taken from “Total budget”).">i</span>
            </button>
          </div>

          <div id="status" class="chip">Waiting…</div>
        </section>

        <!-- Debug -->
        <section class="card">
          <h3>Debug <span class="tip" data-tip="Frontend action logs and contract events.">i</span></h3>
          <pre id="log"></pre>
        </section>
      </div>

      <!-- DCA + Balances -->
      <div class="grid">
        <section class="card">
          <h3>Create DCA Intent</h3>

          <div class="row3">
            <div>
              <label>Amount per tick (USDC, 6 decimals)
                <span class="tip" data-tip="How much to spend each cycle. 1 USDC = 1,000,000. Encrypted.">i</span>
              </label>
              <input id="amt" type="number" value="1000000" />
            </div>
            <div>
              <label>Total budget (USDC, 6 decimals)
                <span class="tip" data-tip="Maximum budget for the strategy. Decreases by the tick amount each run. Encrypted.">i</span>
              </label>
              <input id="bud" type="number" value="5000000" />
            </div>
            <div>
              <label>Interval (sec)
                <span class="tip" data-tip="Run frequency in seconds. Public value.">i</span>
              </label>
              <input id="intv" type="number" value="60" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Start (unix)
                <span class="tip" data-tip="First run timestamp. If in the past, the user will join the next due batch.">i</span>
              </label>
              <input id="start" type="number" />
            </div>
            <div>
              <label>Participants (comma-separated)
                <span class="tip" data-tip="Addresses to consider for the batch. Only those with nextRunTs ≤ now are included.">i</span>
              </label>
              <input id="parts" placeholder="0xabc...,0xdef..." />
            </div>
          </div>

          <div class="actions">
            <button id="btnSubmit" class="btn light" disabled>
              Submit Intent <span class="tip" data-tip="Encrypt amount/budget and save the schedule.">i</span>
            </button>
            <button id="btnTrigger" class="btn dark" disabled>
              Trigger Batch <span class="tip" data-tip="Aggregate encrypted contributions and store total handle.">i</span>
            </button>
          </div>

          <div class="sep"></div>
          <small style="color:var(--muted)">Tip: 1 USDC = 1,000,000 (6 decimals)</small>
        </section>

        <section class="card">
          <h3>Balances & Batch</h3>

          <div class="row">
            <div>
              <label>My Encrypted ETH (handle)
                <span class="tip" data-tip="Handle of your encrypted ETH balance stored in the contract.">i</span>
              </label>
              <input id="myHandle" disabled />
            </div>
            <div>
              <label>Decrypted (wei)
                <span class="tip" data-tip="Result of your personal user decryption — in wei.">i</span>
              </label>
              <input id="myPlain" disabled />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Batch ID
                <span class="tip" data-tip="The batch number you’re working with (1, 2, 3 …).">i</span>
              </label>
              <input id="batchId" type="number" min="1" />
            </div>
            <div>
              <label>Total handle (batch)
                <span class="tip" data-tip="Handle of the encrypted Σ(contrib_i). Can be publicly decrypted via Relayer.">i</span>
              </label>
              <input id="totalHandle" disabled />
            </div>
          </div>

          <div class="actions">
            <button id="btnGetBal" class="btn light" disabled>
              Get My Balance <span class="tip" data-tip="Fetch the handle of your encrypted balance from the contract.">i</span>
            </button>
            <button id="btnUserDecrypt" class="btn light" disabled>
              User Decrypt <span class="tip" data-tip="Personal decryption via EIP-712 signature.">i</span>
            </button>
            <button id="btnGetBatch" class="btn light" disabled>
              Get Batch Info <span class="tip" data-tip="Read total handle, users, and status flags of the batch.">i</span>
            </button>
            <button id="btnPublicDecrypt" class="btn light" disabled>
              Public Decrypt Total <span class="tip" data-tip="Publicly decrypt Σcontrib_i (the contract marks it as publicly decryptable).">i</span>
            </button>
            <button id="btnFinalize" class="btn dark" disabled>
              Finalize (owner) <span class="tip" data-tip="Send the plaintext total to the contract, swap USDC→ETH, and distribute (encrypted). Requires owner role.">i</span>
            </button>
          </div>
        </section>
      </div>
    </main>

    <!-- App -->
    <script type="module" src="./js/app.js"></script>
  </body>
</html>
